# =============================================================================
# OpenClaw BFF - Local .env (infra-compatible) - VERSIONE COMMENTATA
# =============================================================================
# Questo file configura il backend FastAPI (BFF) per parlare con:
# - Postgres (docker compose, esposto su localhost:5432)
# - MinIO (docker compose, esposto su localhost:9000 / console 9001)
# - Keycloak (docker compose, esposto su localhost:8080)
# - OpenClaw (gira su host, NON in compose)
#
# NOTE IMPORTANTI:
# 1) NON usare virgolette (") a meno che tu non sappia cosa fai: spesso rompono export/parse.
# 2) Evita spazi attorno al '='.
# 3) Se modifichi questo file, riavvia il backend (CTRL+C e rilancia dev_run.sh).
# =============================================================================


# =============================================================================
# 1) Backend FastAPI / Uvicorn
# =============================================================================

# Porta di ascolto del backend (Swagger su http://localhost:<porta>/docs)
BFF_PORT=8000

# Livello log (tipici: debug, info, warning, error)
BFF_LOG_LEVEL=info

# Ambiente (solo informativo: local/dev/prod)
BFF_ENV=local

# CORS: origini consentite per il browser (frontend)
# - In dev puoi usare '*' (qualsiasi origin)
# - In prod metti una lista separata da virgole, es:
#   https://myfrontend.com,https://admin.myfrontend.com
BFF_CORS_ORIGINS=*


# =============================================================================
# 2) Autenticazione (Keycloak) - DISATTIVABILE
# =============================================================================
# Se true:
# - il backend richiede JWT valido in Authorization: Bearer <token>
# - valida la firma via JWKS da Keycloak
# Se false:
# - il backend NON valida JWT
# - puoi usare header X-Debug-User: <userId> per simulare un utente
KEYCLOAK_ENABLED=false

# Base URL di Keycloak (compose: http://localhost:8080)
KEYCLOAK_BASE_URL=http://localhost:8080

# Realm e client OIDC creati dallo script scripts/init_keycloak.sh
KEYCLOAK_REALM=openclaw-bff
KEYCLOAK_CLIENT_ID=openclaw-bff-api

# Credenziali admin usate SOLO dagli script di bootstrap (init_keycloak.sh)
# (Non sono usate dal backend per validare token.)
KEYCLOAK_ADMIN_USER=admin
KEYCLOAK_ADMIN_PASSWORD=admin

# Utente di test creato dallo script init_keycloak.sh
# Usato dai test pytest quando KEYCLOAK_ENABLED=true (password grant)
KEYCLOAK_TEST_USER=testuser
KEYCLOAK_TEST_PASSWORD=testpassword

# User fallback quando KEYCLOAK_ENABLED=false (modalità dev senza JWT)
# Puoi anche passare X-Debug-User nelle request
DEV_USER_ID=dev-user


# =============================================================================
# 3) Database Postgres (docker compose su host)
# =============================================================================
# Questi valori sono coerenti con scripts/init_db.sh:
# - crea role openclaw_bff / password openclaw_bff
# - crea database openclaw_bff
BFF_DB_HOST=localhost
BFF_DB_PORT=5432
BFF_DB_NAME=openclaw_bff
BFF_DB_USER=openclaw_bff
BFF_DB_PASSWORD=openclaw_bff

# URL SQLAlchemy async (è quello che tipicamente usa il backend)
# Se cambi i valori sopra, aggiorna anche questa riga
DATABASE_URL=postgresql+asyncpg://openclaw_bff:openclaw_bff@localhost:5432/openclaw_bff

# Superuser usato dal docker-compose (serve solo se rilanci scripts/init_db.sh con override)
POSTGRES_SUPERUSER=postgres
POSTGRES_SUPERPASS=postgres
POSTGRES_SUPERDB=postgres


# =============================================================================
# 4) MinIO (docker compose su host) - IMPORTANTISSIMO PER IL WARNING
# =============================================================================
# ⚠️ MinIO Python SDK vuole endpoint nel formato: host:port
# ✅ OK:  localhost:9000
# ❌ NO:  http://localhost:9000   (può generare "path in endpoint is not allowed")
MINIO_ENDPOINT=localhost:9000

# Secure = usa HTTPS verso MinIO.
# In locale con compose (http) deve essere false.
MINIO_SECURE=false

# Bucket usato dal backend per salvare upload
# Coerente con scripts/init_minio.sh
MINIO_BUCKET=openclaw-bff

# Console web (solo informativo, non sempre usato dal backend)
MINIO_CONSOLE=http://localhost:9001

# Credenziali root (usate SOLO dallo script init_minio.sh per creare bucket/user/policy)
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin

# Credenziali applicative (usate dal backend per operare nel bucket)
# Coerenti con init_minio.sh:
# - crea user openclaw-bff con policy readwrite
#
# IMPORTANT:
# Alcuni backend leggono MINIO_ACCESS_KEY / MINIO_SECRET_KEY.
# Per evitare mismatch, definiamo entrambe le coppie.
MINIO_BFF_ACCESS_KEY=openclaw-bff
MINIO_BFF_SECRET_KEY=openclaw-bff-secret
MINIO_ACCESS_KEY=openclaw-bff
MINIO_SECRET_KEY=openclaw-bff-secret

# Scadenza delle presigned URL (secondi):
# - PUT: upload da browser/client
# - GET: download (se usi presigned)
MINIO_PRESIGN_EXPIRE_SECONDS=3600

# (Opzionale ma consigliato)
# Se vuoi che il backend costruisca URL “pubbliche” consistenti per passare file a OpenClaw,
# specifica una base URL completa:
# Esempio (host): http://localhost:9000
# Esempio (reverse proxy): https://files.mydomain.com
MINIO_PUBLIC_BASE_URL=http://localhost:9000


# =============================================================================
# 5) OpenClaw (gira su HOST, non nel compose)
# =============================================================================
# Base URL HTTP del Gateway OpenClaw (verifica la tua porta reale!)
# Serve per proxy /v1/responses, /v1/chat/completions, /tools/invoke ecc.

OPENCLAW_WS_DEBUG=1
OPENCLAW_WS_DEBUG_PAYLOAD=1
OPENCLAW_WS_DEBUG_EVENTS=chat,agent
# opzionale: filtra per un runId preciso (lo vedi nello stream)
# OPENCLAW_WS_DEBUG_RUNID=49c43345e7a449bcae4f92f0810c36e1

OPENCLAW_HTTP_BASE=http://localhost:18789

# URL WebSocket RPC del Gateway (per chat.abort, chat.inject, sessions.list ecc.)
OPENCLAW_WS_URL=ws://localhost:18789/ws

# Token del gateway OpenClaw (se hai abilitato auth token lato OpenClaw).
# Se non usi token, lascia vuoto.
OPENCLAW_BEARER_TOKEN=dce336a86dc9a3cb2833bc6aab78bcacba5f7281bac1b302

# Client identity (VALORI AMMESSI: webchat|cli|ui|backend|node|probe|test)
OPENCLAW_CLIENT_ID=gateway-client
OPENCLAW_CLIENT_MODE=backend

#OPENCLAW_CLIENT_ID=tui
#OPENCLAW_CLIENT_MODE=tui

#OPENCLAW_CLIENT_ID=webchat
#OPENCLAW_CLIENT_MODE=webchat

# AuthZ (il gateway usa role=operator|node)
OPENCLAW_ROLE=operator
OPENCLAW_SCOPES=operator.read,operator.write

# Device identity (consigliato: riusa quella di OpenClaw CLI se esiste)
# Se hai già openclaw installato e funzionante:
OPENCLAW_IDENTITY_FILE=~/.openclaw/identity/device.json

# Se vuoi tenerla separata dal CLI:
# OPENCLAW_STATE_DIR=~/.openclaw-bff

# Device identity per WS (solo se OpenClaw richiede signing device).
# Se non ti serve, lascia vuoti questi campi.
#OPENCLAW_DEVICE_ID=
#OPENCLAW_DEVICE_PRIVATE_KEY_B64=


# =============================================================================
# 6) Policy / default del BFF
# =============================================================================
# Se true, il backend accetterà (con prudenza) che il client invii sessionKey openclaw.
# In generale: lascia false (anti-IDOR).
BFF_ALLOW_CLIENT_SESSION_KEY=false

# Agent di default se il client non specifica agentId / model
BFF_DEFAULT_AGENT_ID=main


# =============================================================================
# 7) Test (pytest)
# =============================================================================
# Base URL dove gira il backend (usato dai test)
BASE_URL=http://localhost:8000

# (Opzionale) Se in futuro vuoi abilitare i test “OpenClaw-dependent” via env:
# RUN_OPENCLOW_TESTS=true
# RUN_OPENCLOW_TESTS=false
